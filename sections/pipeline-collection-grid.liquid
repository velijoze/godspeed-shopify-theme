{{ 'pipeline-collection.css' | asset_url | stylesheet_tag }}

{%- paginate collection.products by section.settings.products_per_page | default: 24 -%}

<div class="pipeline-collection-container section-{{ section.id }}-padding">
  
  <!-- Main Layout Grid -->
  <div class="pipeline-collection-layout" 
       style="--custom-sidebar-width: {{ section.settings.custom_sidebar_width | default: 280 }}px; 
              --custom-layout-gap: {{ section.settings.custom_layout_gap | default: 40 }}px; 
              --custom-max-width: {{ section.settings.custom_max_width | default: 1400 }}px;">
    
    <!-- Filters Sidebar -->
    <aside class="pipeline-filters-sidebar" data-sticky-filters>
      
      <!-- Collections Filter -->
      <div class="filter-group" data-filter-group="collections">
        <h3 class="filter-title">ALL COLLECTIONS</h3>
        <div class="filter-options">
          {%- for collection in collections -%}
            <label class="filter-option" {% if forloop.index > 8 %}data-hidden="true"{% endif %}>
              <input type="checkbox" 
                     name="collection" 
                     value="{{ collection.handle }}"
                     {% if collection.handle == current_collection.handle %}checked{% endif %}
                     data-filter="collection">
              <span class="checkmark"></span>
              {{ collection.title }}
            </label>
          {%- endfor -%}
          {%- if collections.size > 8 -%}
            <button class="show-more-btn" data-show-more="collections">
              SHOW MORE
            </button>
          {%- endif -%}
        </div>
      </div>
      
      <!-- Availability Filter -->
      <div class="filter-group" data-filter-group="availability">
        <h3 class="filter-title">AVAILABILITY</h3>
        <div class="filter-options">
          <label class="filter-option">
            <input type="checkbox" name="availability" value="in_stock" data-filter="availability">
            <span class="checkmark"></span>
            IN STOCK
          </label>
          <label class="filter-option">
            <input type="checkbox" name="availability" value="out_of_stock" data-filter="availability">
            <span class="checkmark"></span>
            OUT OF STOCK
          </label>
        </div>
      </div>
      
      <!-- Price Range Filter -->
      <div class="filter-group" data-filter-group="price">
        <h3 class="filter-title">PRICE</h3>
        <div class="price-range-container">
          <div class="price-inputs">
            <div class="price-input">
              <label>CHF</label>
              <input type="number" 
                     id="price-min" 
                     placeholder="0" 
                     min="0" 
                     data-price-min>
              <button class="price-arrow up" data-price-action="min-up">▲</button>
              <button class="price-arrow down" data-price-action="min-down">▼</button>
            </div>
            <div class="price-input">
              <label>CHF</label>
              <input type="number" 
                     id="price-max" 
                     placeholder="4999" 
                     min="0" 
                     data-price-max>
              <button class="price-arrow up" data-price-action="max-up">▲</button>
              <button class="price-arrow down" data-price-action="max-down">▼</button>
            </div>
          </div>
          <div class="price-slider-container">
            <div class="price-slider" data-price-slider>
              <div class="price-slider-track"></div>
              <div class="price-slider-handle min" data-handle="min"></div>
              <div class="price-slider-handle max" data-handle="max"></div>
            </div>
          </div>
        </div>
      </div>
      
    </aside>

    <!-- Main Content Area -->
    <div class="pipeline-main-content">
      
      <!-- Toolbar -->
      <div class="pipeline-toolbar">
        <div class="toolbar-left">
          <button class="hide-filters-btn" data-toggle-filters>
            <span class="hamburger-icon">☰</span>
            HIDE FILTERS
          </button>
          <span class="product-count-display">
            {{ collection.products_count }} products
          </span>
        </div>
        
        <div class="toolbar-right">
          <select class="pipeline-sort-select" data-sort-select>
            <option value="best-selling">BEST SELLING</option>
            <option value="featured">FEATURED</option>
            <option value="price-low-high">PRICE: LOW TO HIGH</option>
            <option value="price-high-low">PRICE: HIGH TO LOW</option>
            <option value="newest">NEWEST</option>
          </select>
          
          <div class="grid-view-toggle">
            <button class="view-btn active" data-view="{{ section.settings.columns_desktop | default: 3 }}" title="{{ section.settings.columns_desktop | default: 3 }} columns">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="1" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="6" y="1" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="11" y="1" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="1" y="6" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="6" y="6" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="11" y="6" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="1" y="11" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="6" y="11" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="11" y="11" width="4" height="4" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
              </svg>
            </button>
            <button class="view-btn" data-view="4" title="4 columns">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="1" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="5" y="1" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="9" y="1" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="13" y="1" width="2" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="1" y="5" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="5" y="5" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="9" y="5" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="13" y="5" width="2" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="1" y="9" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="5" y="9" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="9" y="9" width="3" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="13" y="9" width="2" height="3" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="1" y="13" width="3" height="2" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="5" y="13" width="3" height="2" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="9" y="13" width="3" height="2" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <rect x="13" y="13" width="2" height="2" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Products Grid -->
      <div class="pipeline-products-container">
        <ul class="pipeline-products-grid" 
            data-products-grid
            style="--custom-columns-desktop: {{ section.settings.columns_desktop | default: 3 }};
                   --custom-columns-mobile: {{ section.settings.columns_mobile | default: 2 }};
                   --custom-card-padding: {{ section.settings.custom_card_padding | default: 15 }}px;
                   --custom-card-border-radius: {{ section.settings.custom_card_border_radius | default: 0 }}px;
                   --custom-card-title-size: {{ section.settings.custom_card_title_size | default: 14 }}px;
                   --custom-card-price-size: {{ section.settings.custom_card_price_size | default: 14 }}px;">
          
          {%- for product in collection.products -%}
            <li class="pipeline-product-card" 
                data-product-card
                data-collection="{{ collection.handle }}"
                data-available="{{ product.available }}"
                data-price="{{ product.price | money_without_currency | replace: ',', '' }}"
                data-created="{{ product.created_at }}"
                data-featured="{{ product.featured }}"
                data-sales="0">
              
              <!-- Product Image -->
              <div class="pipeline-card-media">
                {%- if product.available == false -%}
                  <div class="pipeline-card-badge sold-out" 
                       style="background-color: {{ section.settings.custom_sold_out_badge_color | default: '#6b7280' }}; color: #ffffff; font-size: {{ section.settings.custom_badge_font_size | default: 12 }}px;">
                    SOLD OUT
                  </div>
                {%- elsif product.compare_at_price > product.price -%}
                  {%- assign discount_amount = product.compare_at_price | minus: product.price -%}
                  {%- assign discount_percentage = discount_amount | times: 100.0 | divided_by: product.compare_at_price | round -%}
                  <div class="pipeline-card-badge sale" 
                       style="background-color: {{ section.settings.custom_sale_badge_color | default: '#dc2626' }}; color: #ffffff; font-size: {{ section.settings.custom_badge_font_size | default: 12 }}px;">
                    -{{ discount_percentage }}%
                  </div>
                {%- endif -%}
                
                <a href="{{ product.url }}" class="pipeline-card-image-link">
                  <img class="pipeline-product-image"
                       src="{{ product.featured_media | img_url: '400x400' }}"
                       alt="{{ product.title | escape }}"
                       loading="{% if forloop.index > 4 %}lazy{% else %}eager{% endif %}"
                       style="aspect-ratio: {% if section.settings.image_ratio == 'square' %}1{% elsif section.settings.image_ratio == 'portrait' %}3/4{% else %}adapt{% endif %};">
                  
                  {%- if section.settings.show_secondary_image and product.media[1] -%}
                    <img class="pipeline-product-image-secondary"
                         src="{{ product.media[1] | img_url: '400x400' }}"
                         alt="{{ product.title | escape }}"
                         loading="lazy"
                         style="aspect-ratio: {% if section.settings.image_ratio == 'square' %}1{% elsif section.settings.image_ratio == 'portrait' %}3/4{% else %}adapt{% endif %};">
                  {%- endif -%}
                </a>
              </div>
              
              <!-- Product Info -->
              <div class="pipeline-card-content">
                <h3 class="pipeline-card-title">
                  <a href="{{ product.url }}">{{ product.title | escape }}</a>
                </h3>
                
                {%- if section.settings.show_vendor and product.vendor -%}
                  <div class="pipeline-card-vendor">{{ product.vendor }}</div>
                {%- endif -%}
                
                {%- if section.settings.show_rating -%}
                  <div class="pipeline-card-rating">
                    <!-- Rating stars would go here -->
                  </div>
                {%- endif -%}
                
                <div class="pipeline-card-price">
                  {%- if product.available == false -%}
                    <span class="pipeline-sold-out-text">SOLD OUT</span>
                  {%- else -%}
                    {%- if product.compare_at_price > product.price -%}
                      <span class="pipeline-original-price">{{ product.compare_at_price | money }}</span>
                      <span class="pipeline-sale-price">{{ product.price | money }}</span>
                    {%- else -%}
                      <span class="pipeline-regular-price">{{ product.price | money }}</span>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              </div>
              
            </li>
          {%- endfor -%}
        </ul>
        
        {%- if paginate.pages > 1 -%}
          {% render 'pagination', paginate: paginate, anchor: '' %}
        {%- endif -%}
        
      </div>
      
    </div>
  </div>
</div>

<script src="{{ 'pipeline-collection.js' | asset_url }}" defer="defer"></script>
{%- endpaginate -%}

{% schema %}
{
  "name": "Pipeline Custom Collection Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 12,
      "max": 48,
      "step": 6,
      "default": 24,
      "label": "Products per page"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 3,
      "label": "Desktop columns"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "2",
      "label": "Mobile columns"
    },
    {
      "type": "range",
      "id": "custom_sidebar_width",
      "min": 200,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Sidebar width",
      "default": 280
    },
    {
      "type": "range",
      "id": "custom_layout_gap",
      "min": 20,
      "max": 80,
      "step": 10,
      "unit": "px",
      "label": "Layout gap",
      "default": 40
    },
    {
      "type": "range",
      "id": "custom_max_width",
      "min": 1200,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "label": "Maximum width",
      "default": 1400
    },
    {
      "type": "header",
      "content": "Product Card Settings"
    },
    {
      "type": "range",
      "id": "custom_card_padding",
      "min": 5,
      "max": 30,
      "step": 5,
      "unit": "px",
      "label": "Card padding",
      "default": 15
    },
    {
      "type": "range",
      "id": "custom_card_border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Card border radius",
      "default": 0
    },
    {
      "type": "range",
      "id": "custom_card_title_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Card title font size",
      "default": 14
    },
    {
      "type": "range",
      "id": "custom_card_price_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Card price font size",
      "default": 14
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": true,
      "label": "Show secondary image on hover"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show product vendor"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "Show product rating"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "Adapt to image"
        },
        {
          "value": "square",
          "label": "Square"
        },
        {
          "value": "portrait",
          "label": "Portrait"
        }
      ],
      "default": "square",
      "label": "Image ratio"
    },
    {
      "type": "header",
      "content": "Badge Settings"
    },
    {
      "type": "color",
      "id": "custom_sale_badge_color",
      "label": "Sale badge color",
      "default": "#dc2626"
    },
    {
      "type": "color",
      "id": "custom_sold_out_badge_color",
      "label": "Sold out badge color",
      "default": "#6b7280"
    },
    {
      "type": "range",
      "id": "custom_badge_font_size",
      "min": 8,
      "max": 16,
      "step": 1,
      "unit": "px",
      "label": "Badge font size",
      "default": 12
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ]
}
{% endschema %}